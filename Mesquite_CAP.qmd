---
title: "Multivariate Analysis - Mesquite"
subtitle: "adapted from IRC Data analysis for R2R summer institute 2021"
author: "Janet Gonzalez, Amy Henry, adapted from Diane Campbell"
date: "created Aug 3,2021, last modified 2/19/24"
output: html_document
---

# Multivariate Analysis - Constrained Analysis

```{r}
##  Load packages
library(tidyverse)
library(vegan)
library(ggplot2)
library(ggordiplots)
```

```{r}
# Read in BeeFlat data
Mesquite <-read.csv("Mesquite_AllData.csv")

```

```{r}
MesquiteDiff <- Mesquite %>%
    filter(
        (Site == 1)| 
        (Site == 5)
      )

MesquiteDiff <- MesquiteDiff |>
  mutate(Site = case_when(Site == "1" ~ "BSB", 
                          Site == "5" ~ "CDL"))
```

### NMDS (non-metric dimensional scaling) is an unconstrained analysis

Function `metaMDS()` requires numeric data only.

```{r}
# reduce our matrix to include only the community data, no reference columns
numericonly <- MesquiteDiff |> select(Resprouting, CrownSizeShape, CrownFoliarDensity, DeadBranches)

# Run the NMDS function
mydata.mds <- metaMDS(numericonly, distance="bray", k=2, autotransform=FALSE, noshare = FALSE)
# stress < 0.2 which means NMDS represents the variation well

```

#### Basic plots of NMDS

```{r}
plot(mydata.mds,type="t",display=c("species"))
```

```{r}
plot(mydata.mds,type="t",display=c("sites"))
```

```{r}
plot1 <- ordiplot(mydata.mds, choices=c(1,2)) #sites are circles, + are species
```

#### Making a better plot

Adding species vectors to the plot of sites

```{r}

MesquiteDiff.sspfit <- gg_envfit(mydata.mds, numericonly) 

# ggplot version

Misquite_points <- bind_cols(MesquiteDiff,MesquiteDiff.sspfit$df_ord)
Misquite_arrows <- MesquiteDiff.sspfit$df_arrows


library(ordr)

ggplot() + 
  geom_point(data = Misquite_points,  
             aes(x = x, y = y, color = Site)) + 
  geom_vector(data = Misquite_arrows, aes(x = x, y = y)) + 
  geom_text(data = Misquite_arrows, 
            aes(x = x, y = y, label = var), 
            vjust = 1)+ 
  labs(y = "NMDS2", x = "NMDS1")

 MesquiteDiff.sspfit$df_arrows
```

```{r}
numericonly2 <- MesquiteDiff |> select(Site,Resprouting, CrownSizeShape, CrownFoliarDensity, DeadBranches)



trial<-gg_envfit(mydata.mds, numericonly2) 

trial + geom_point(aes(color = Site))
```

### CAP

#### CAP analysis

First, we'll perform CAP on the same ZeroYr data set to show how it differs from NMDS in finding differences among habitats.

```{r}
MesquiteDiff.cap <- capscale(numericonly ~ Site, MesquiteDiff, dist="bray") 
MesquiteDiff.cap
```

```{r}
scores(MesquiteDiff.cap)
```

#### Test for differences using PERMANOVA

We can run anova directly on our capscale output object.

```{r}
anova(MesquiteDiff.cap) 
```

-   Permutation ANOVA also shows significant difference at start among habitats

#### Basic plots

```{r}
plot(MesquiteDiff.cap, display=c("sp", "sites","cn"),type="text")
```

```{r}
plot(MesquiteDiff.cap, display=c("sp", "cn"),type="text")# xlim=c(-2,2), ylim=c(-1,2))
```

#### Nicer plots of CAP

```{r}
{
ordiplot(MesquiteDiff.cap, type = "n", main = "CAP of Mesquite")
orditorp(MesquiteDiff.cap, display = "sites", labels = MesquiteDiff$habitat, pch = c(16, 8) [(MesquiteDiff$Site)], col = c("red", "blue") [as.factor(MesquiteDiff$Site)])
ordihull(MesquiteDiff.cap, groups = MesquiteDiff$Site, draw = "polygon", lty = 1, col = "grey90")
orditorp(MesquiteDiff.cap, display = "species")
}

gg_ordiplot(
    MesquiteDiff.cap,
    groups = MesquiteDiff$Site,
    scaling = 1,
    choices = c(1, 2),
    show.groups = "all",
    label = TRUE,
    hull = TRUE,
    ellipse = FALSE,
    spiders = FALSE,
    pt.size = 1,
    plot = TRUE
) 
```

Conclusion: Note that CAP does a better job of separating the two habitats than does NMDS!

This happens because the CAP ordination is specifically constrained to look for habitat separation
